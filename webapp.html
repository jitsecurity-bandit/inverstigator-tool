<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DynamoDB Debug Tool - Web App</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1542.0.min.js"></script>
    <style>
        /* Tab-specific styles */
        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #475569;
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            background: #334155;
            border: none;
            color: #e2e8f0;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: #475569;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Debug section styles */
        .debug-section {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .debug-section h3 {
            color: #f87171;
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 2px solid #f87171;
            padding-bottom: 0.5rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .debug-actions {
            display: flex;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        
        .debug-btn {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
        }
        
        .debug-btn:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(248, 113, 113, 0.4);
        }
        
        .debug-btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .stuck-pr-table {
            width: 100%;
            border-collapse: collapse;
            margin: 2rem 0;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        /* Responsive stuck PR table */
        @media (max-width: 1400px) {
            .stuck-pr-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        .stuck-pr-table th,
        .stuck-pr-table td {
            border: 1px solid #475569;
            padding: 1rem;
            text-align: left;
        }
        
        .stuck-pr-table th {
            background: #334155;
            color: #60a5fa;
            font-weight: 600;
        }
        
        .stuck-pr-table tr:nth-child(even) {
            background: #2d3748;
        }
        
        .stuck-pr-table tr:hover {
            background: #374151;
        }
        
        .pr-link {
            color: #60a5fa;
            text-decoration: none;
            font-weight: 500;
        }
        
        .pr-link:hover {
            text-decoration: underline;
            color: #93c5fd;
        }
        
        .debug-results-section {
            margin-top: 2rem;
        }
        
        .debug-results-section h4 {
            color: #e2e8f0;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Enhanced table styles for new functionality */
        .expandable-cell {
            position: relative;
        }

        .cell-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
        }

        .cell-text {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .expand-cell-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .expand-cell-btn:hover {
            background: #60a5fa;
        }

        /* Fix table layout and column widths */
        .results-table {
            table-layout: fixed;
            width: 100%;
            min-width: 100%;
        }

        .results-table th,
        .results-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0.75rem 0.5rem;
        }

        /* Responsive column widths */
        .results-table th:nth-child(1), .results-table td:nth-child(1) { width: 9%; } /* JIT Event ID */
        .results-table th:nth-child(2), .results-table td:nth-child(2) { width: 9%; } /* Event Name */
        .results-table th:nth-child(3), .results-table td:nth-child(3) { width: 9%; } /* Execution ID / Created At */
        .results-table th:nth-child(4), .results-table td:nth-child(4) { width: 6%; } /* Status / Modified At */
        .results-table th:nth-child(5), .results-table td:nth-child(5) { width: 8%; } /* Control Name / Progress */
        .results-table th:nth-child(6), .results-table td:nth-child(6) { width: 8%; } /* Asset Name / Status */
        .results-table th:nth-child(7), .results-table td:nth-child(7) { width: 5%; } /* PR Number */
        .results-table th:nth-child(8), .results-table td:nth-child(8) { width: 6%; } /* Has Findings / Additional Data */
        .results-table th:nth-child(9), .results-table td:nth-child(9) { width: 7%; } /* Created At / Actions */
        .results-table th:nth-child(10), .results-table td:nth-child(10) { width: 7%; } /* Completed At */
        .results-table th:nth-child(11), .results-table td:nth-child(11) { width: 8%; } /* Additional Data */
        .results-table th:nth-child(12), .results-table td:nth-child(12) { width: 18%; } /* Actions - increased width */

        /* Media query for smaller screens */
        @media (max-width: 1200px) {
            .results-table th:nth-child(5),
            .results-table td:nth-child(5),
            .results-table th:nth-child(6), 
            .results-table td:nth-child(6),
            .results-table th:nth-child(8), 
            .results-table td:nth-child(8),
            .results-table th:nth-child(10), 
            .results-table td:nth-child(10) {
                display: none;
            }

            .results-table th:nth-child(1), .results-table td:nth-child(1) { width: 15%; }
            .results-table th:nth-child(2), .results-table td:nth-child(2) { width: 15%; }
            .results-table th:nth-child(3), .results-table td:nth-child(3) { width: 15%; }
            .results-table th:nth-child(4), .results-table td:nth-child(4) { width: 8%; }
            .results-table th:nth-child(7), .results-table td:nth-child(7) { width: 8%; }
            .results-table th:nth-child(9), .results-table td:nth-child(9) { width: 12%; }
            .results-table th:nth-child(11), .results-table td:nth-child(11) { width: 15%; }
            .results-table th:nth-child(12), .results-table td:nth-child(12) { width: 20%; }
        }

        /* Media query for mobile devices */
        @media (max-width: 768px) {
            .results-table th:nth-child(1), .results-table td:nth-child(1),
            .results-table th:nth-child(2), .results-table td:nth-child(2),
            .results-table th:nth-child(11), .results-table td:nth-child(11) {
                display: none;
            }

            .results-table th:nth-child(3), .results-table td:nth-child(3) { width: 30%; }
            .results-table th:nth-child(4), .results-table td:nth-child(4) { width: 20%; }
            .results-table th:nth-child(7), .results-table td:nth-child(7) { width: 15%; }
            .results-table th:nth-child(9), .results-table td:nth-child(9) { width: 20%; }
            .results-table th:nth-child(12), .results-table td:nth-child(12) { width: 30%; }

            .action-btn {
                padding: 0.4rem 0.4rem;
                font-size: 0.75rem;
            }
        }

        /* Expanded cell styles */
        .cell-content.expanded {
            white-space: normal;
            word-break: break-all;
            min-height: 3rem;
            align-items: flex-start;
            padding: 0.25rem 0;
        }

        .cell-content.expanded .cell-text {
            white-space: normal;
            word-break: break-all;
            line-height: 1.4;
            max-height: 6rem;
            overflow-y: auto;
        }

        /* Make expanded rows taller */
        .results-table tr:has(.cell-content.expanded) {
            height: auto;
        }

        .results-table tr:has(.cell-content.expanded) td {
            vertical-align: top;
            padding: 0.75rem 0.5rem;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #475569;
            border-radius: 8px;
            max-width: 100%;
            margin-bottom: 2rem;
        }

        .errors-cell {
            max-width: 200px;
        }

        .error-cell {
            position: relative;
        }

        .error-preview {
            color: #f87171;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .error-count {
            color: #94a3b8;
            font-size: 0.8rem;
            font-style: italic;
        }

        .error-full {
            background: #1e293b;
            border: 1px solid #f87171;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .error-full pre {
            margin: 0;
            color: #f87171;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .additional-fields-cell {
            max-width: 200px;
        }

        .additional-fields {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .fields-count {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .additional-fields-content {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .additional-fields-content pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.8rem;
            white-space: pre-wrap;
        }

        .expand-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .expand-btn:hover {
            background: #60a5fa;
        }

        .expand-btn.expanded {
            background: #60a5fa;
        }

        .expand-btn.small {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }

        .expanded-row {
            background: #0f172a !important;
        }

        .expanded-content {
            padding: 1.5rem;
            border-top: 2px solid #475569;
        }

        .expanded-content h4 {
            color: #60a5fa;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .expanded-content pre {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 1rem;
            color: #e2e8f0;
            font-size: 0.8rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .action-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.3rem;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            display: inline-block;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #60a5fa;
        }

        .action-btn.view {
            background: #059669;
        }

        .action-btn.view:hover {
            background: #047857;
        }

        .action-btn.copy {
            background: #7c3aed;
        }

        .action-btn.copy:hover {
            background: #6d28d9;
        }

        .action-btn.expand-row {
            background: #ea580c;
        }

        .action-btn.expand-row:hover {
            background: #dc2626;
        }

        .action-btn.expanded {
            background: #dc2626;
        }

        .actions-cell {
            white-space: normal;
            min-width: 150px;
        }

        /* Enhanced expanded view styles */
        .expanded-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #475569;
        }

        .expanded-header h4 {
            margin: 0;
            color: #60a5fa;
            font-size: 1.3rem;
        }

        .expanded-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .expanded-section {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .expanded-section h5 {
            margin: 0 0 1rem 0;
            color: #a78bfa;
            font-size: 1.1rem;
            font-weight: 600;
            border-bottom: 1px solid #475569;
            padding-bottom: 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .info-value {
            font-size: 1rem;
            color: #e2e8f0;
            font-weight: 400;
            word-break: break-all;
        }

        .info-value.status-started {
            color: #fbbf24;
        }

        .action-btn.download {
            background-color: #4CAF50;
            margin-left: 5px;
        }

        .action-btn.download:hover {
            background-color: #45a049;
        }

        .info-value.status-success {
            color: #10b981;
        }

        .info-value.status-failure {
            color: #f87171;
        }

        .info-value.status-timeout {
            color: #f97316;
        }

        .context-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .context-subsection {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 1rem;
        }

        .context-subsection h6 {
            margin: 0 0 1rem 0;
            color: #60a5fa;
            font-size: 1rem;
            font-weight: 600;
        }

        .errors-expanded {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .error-item {
            background: #1e293b;
            border: 1px solid #f87171;
            border-radius: 6px;
            padding: 1rem;
        }

        .error-header {
            color: #f87171;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .error-content {
            margin: 0;
            color: #f87171;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .raw-json-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .raw-json {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 1rem;
            color: #e2e8f0;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            margin: 0;
        }

        /* Responsive design for expanded view */
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .expanded-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .notification.info {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.fade-out {
            opacity: 0;
        }

        /* Hide the old inline expansion */
        .expanded-row {
            display: none !important;
        }

        /* Large modal window styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            width: 95%;
            max-width: 1400px;
            height: 90%;
            max-height: 900px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #475569;
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
        }

        .modal-header h3 {
            margin: 0;
            color: #60a5fa;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: #ef4444;
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #dc2626;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .modal-sections {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .modal-section {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .modal-section h4 {
            margin: 0 0 1.5rem 0;
            color: #a78bfa;
            font-size: 1.2rem;
            font-weight: 600;
            border-bottom: 2px solid #334155;
            padding-bottom: 0.5rem;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .modal-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .modal-info-label {
            font-size: 0.9rem;
            color: #94a3b8;
            font-weight: 600;
        }

        .modal-info-value {
            font-size: 1rem;
            color: #e2e8f0;
            font-weight: 400;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .modal-info-value.status-started {
            color: #fbbf24;
            font-weight: 600;
        }

        .modal-info-value.status-success {
            color: #10b981;
            font-weight: 600;
        }

        .modal-info-value.status-failure {
            color: #f87171;
            font-weight: 600;
        }

        .modal-info-value.status-timeout {
            color: #f97316;
            font-weight: 600;
        }

        .modal-errors {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .modal-error-item {
            background: #1e293b;
            border: 1px solid #f87171;
            border-radius: 6px;
            padding: 1rem;
        }

        .modal-error-header {
            color: #f87171;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .modal-error-content {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .modal-error-content pre {
            margin: 0;
            color: #f87171;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .modal-context-sections {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .modal-context-subsection {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 1.5rem;
        }

        .modal-context-subsection h5 {
            margin: 0 0 1rem 0;
            color: #60a5fa;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-raw-json {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 1.5rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .modal-raw-json pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .modal-action-btn {
            background: #475569;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .modal-action-btn:hover {
            background: #60a5fa;
        }

        .modal-action-btn.copy {
            background: #7c3aed;
        }

        .modal-action-btn.copy:hover {
            background: #6d28d9;
        }

        /* Additional Data Modal Styles */
        .additional-data-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .additional-data-section {
            margin-bottom: 2rem;
            border: 1px solid #374151;
            border-radius: 8px;
            overflow: hidden;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .additional-data-section h4 {
            margin: 0;
            padding: 1rem;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            border-bottom: 1px solid #4b5563;
        }

        .additional-data-grid {
            padding: 1rem;
            display: grid;
            gap: 1rem;
        }

        .additional-data-item {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 1rem;
            align-items: start;
            padding: 0.75rem;
            background: rgba(55, 65, 81, 0.3);
            border-radius: 6px;
            border-left: 3px solid #60a5fa;
        }

        .additional-data-label {
            font-weight: 600;
            color: #93c5fd;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .additional-data-value {
            color: #e2e8f0;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
            font-size: 0.85rem;
            word-break: break-all;
            line-height: 1.4;
        }

        .additional-data-value.string-value {
            background: rgba(34, 197, 94, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 2px solid #22c55e;
        }

        .additional-data-value.other-value {
            background: rgba(168, 85, 247, 0.1);
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 2px solid #a855f7;
        }

        .additional-data-complex {
            margin: 1rem;
            border: 1px solid #4b5563;
            border-radius: 6px;
            overflow: hidden;
            background: rgba(31, 41, 55, 0.5);
        }

        .additional-data-complex-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(55, 65, 81, 0.6);
            border-bottom: 1px solid #4b5563;
        }

        .additional-data-json {
            padding: 1rem;
            background: #111827;
        }

        .additional-data-json pre {
            margin: 0;
            font-size: 0.8rem;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
            line-height: 1.5;
        }

        .copy-field-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .copy-field-btn:hover {
            background: #4338ca;
        }

        .no-additional-data {
            text-align: center;
            padding: 2rem;
            color: #9ca3af;
            font-style: italic;
        }

        .expandable-cell .cell-content {
            white-space: nowrap;
        }

        /* Query Mode Selection Styles */
        .query-mode-selection {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border: 1px solid #475569;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .query-mode-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: #334155;
            border: 2px solid #475569;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 1;
        }

        .query-mode-option:hover {
            border-color: #60a5fa;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(96, 165, 250, 0.2);
        }

        .query-mode-option.active {
            background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            border-color: #60a5fa;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.3);
        }

        .query-mode-radio {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #94a3b8;
            border-radius: 50%;
            position: relative;
            margin: 0;
        }

        .query-mode-option.active .query-mode-radio {
            border-color: white;
        }

        .query-mode-radio:checked {
            background: white;
            border-color: white;
        }

        .query-mode-radio:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: #60a5fa;
        }

        .query-mode-option.active .query-mode-radio:checked::after {
            background: #1e293b;
        }

        .query-mode-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .query-mode-description {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }

        .query-mode-content {
            flex: 1;
        }

        .query-mode-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        /* Conditional field styling */
        .form-group.conditional {
            transition: all 0.3s ease;
        }

        .form-group.conditional.hidden {
            display: none;
        }

        /* Enhanced form styling */
        .filters-form {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        /* Custom filters examples styling */
        .custom-filters-examples {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(55, 65, 81, 0.3);
            border: 1px solid #374151;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #9ca3af;
        }

        .custom-filters-examples code {
            background: rgba(96, 165, 250, 0.1);
            color: #93c5fd;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Monaco', monospace;
            font-size: 0.8rem;
        }

        /* Grid layout classes are defined in styles.css */
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>üîç DynamoDB Debug Tool</h1>
            <div class="header-controls">
                <div class="aws-status" id="aws-status">
                    <div class="status-indicator no-profile"></div>
                    <span class="status-text">Checking AWS connection...</span>
                </div>
            </div>
        </header>

        <main class="main">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('query')">Query Tool</button>
                <button class="tab" onclick="switchTab('debug')">Error Debugging</button>
            </div>

            <div id="query-tab" class="tab-content active">
                <section class="filters-section">
                    <h2>Query Parameters</h2>
                    
                    <!-- Query Mode Selection -->
                    <div class="query-mode-selection">
                        <label class="query-mode-option active" for="mode-executions">
                            <input type="radio" id="mode-executions" name="queryMode" value="executions" class="query-mode-radio" checked>
                            <div class="query-mode-content">
                                <div class="query-mode-label">
                                    <span class="query-mode-icon">üîß</span>
                                    Job Executions
                                </div>
                                <div class="query-mode-description">Query control execution results by status</div>
                            </div>
                        </label>
                        <label class="query-mode-option" for="mode-events">
                            <input type="radio" id="mode-events" name="queryMode" value="events" class="query-mode-radio">
                            <div class="query-mode-content">
                                <div class="query-mode-label">
                                    <span class="query-mode-icon">üìã</span>
                                    JIT Events
                                </div>
                                <div class="query-mode-description">Query JIT events and PR information by status</div>
                            </div>
                        </label>
                    </div>

                    <form id="query-form" class="filters-form-query">
                        <div class="form-group tenant-width">
                            <label for="tenant-id">Tenant ID *</label>
                            <input type="text" id="tenant-id" placeholder="e.g., c21e94b3-e27a-4f26-8035-5028ac81c818" required>
                        </div>

                        <!-- Conditional fields for Job Executions -->
                        <div class="form-group conditional status-width" id="status-group">
                            <label for="status">Status *</label>
                            <select id="status" required>
                                <option value="">Select Status</option>
                                <option value="started">Started</option>
                                <option value="success">Success</option>
                                <option value="failure">Failure</option>
                                <option value="timeout">Timeout</option>
                            </select>
                        </div>

                        <!-- Conditional fields for JIT Events -->
                        <div class="form-group conditional hidden status-width" id="event-status-group">
                            <label for="event-status">Status *</label>
                            <select id="event-status" required>
                                <option value="">Select Status</option>
                                <option value="creating">Creating</option>
                                <option value="started">Started</option>
                                <option value="jobs_sent">Jobs Sent</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>

                        <div class="form-group date-width">
                            <label for="start-date">Start Date</label>
                            <input type="datetime-local" id="start-date">
                        </div>

                        <div class="form-group date-width">
                            <label for="end-date">End Date</label>
                            <input type="datetime-local" id="end-date">
                        </div>

                        <div class="custom-filters-section">
                            <div class="custom-filters-header">
                                <label>Custom Filters</label>
                                <div>
                                    <button type="button" id="add-filter" class="btn-small">Add Filter</button>
                                    <button type="button" id="clear-filters" class="btn-small">Clear All</button>
                                </div>
                            </div>
                            <div id="custom-filters-container"></div>
                            <div class="custom-filters-examples">
                                <small>
                                    <strong>Examples:</strong>
                                    <code>jit_event_name</code>, 
                                    <code>context.jit_event.pull_request_number</code>, 
                                    <code>context.asset.asset_name</code>, 
                                    <code>jit_event.pull_request_title</code>
                                </small>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <span class="btn-text" id="query-btn-text">Query Job Executions</span>
                            </button>
                        </div>
                    </form>
                </section>

                <div id="error-message" class="error-message" style="display: none;"></div>

                <section class="results-section">
                    <div class="results-header">
                        <h2>Results</h2>
                        <div class="results-actions">
                            <button id="export-json" class="btn btn-outline" disabled>Export JSON</button>
                            <button id="export-csv" class="btn btn-outline" disabled>Export CSV</button>
                        </div>
                    </div>
                    <div class="results-count" id="results-count"></div>

                    <div class="table-container">
                        <table id="results-table" class="results-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th data-column="jit_event_id">JIT Event ID</th>
                                    <th data-column="jit_event_name">Event Name</th>
                                    <th data-column="execution_id">Execution ID</th>
                                    <th data-column="status">Status</th>
                                    <th data-column="control_name">Control Name</th>
                                    <th data-column="asset_name">Asset Name</th>
                                    <th data-column="pull_request_number">PR Number</th>
                                    <th data-column="has_findings">Has Findings</th>
                                    <th data-column="created_at">Created At</th>
                                    <th data-column="completed_at">Completed At</th>
                                    <th>Additional Data</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody"></tbody>
                        </table>
                    </div>
                </section>
            </div>

            <div id="debug-tab" class="tab-content">
                <div class="debug-section">
                    <h3>üö® Error Debugging Tools</h3>
                    
                    <div class="form-group">
                        <label for="debug-tenant-id">Tenant ID for Debugging *</label>
                        <input type="text" id="debug-tenant-id" placeholder="e.g., c21e94b3-e27a-4f26-8035-5028ac81c818">
                    </div>

                    <div class="debug-actions">
                        <button class="debug-btn" id="stuck-pr-btn">Find Stuck PR Executions</button>
                        <button class="debug-btn" id="clear-debug-btn">Clear Results</button>
                    </div>

                    <div id="stuck-pr-stats" class="debug-results-section" style="display: none;">
                        <h4>üìä Stuck PR Statistics</h4>
                        <div class="stats-grid" id="stats-grid"></div>
                    </div>

                    <div id="stuck-pr-results" class="debug-results-section" style="display: none;">
                        <h4>üìã Stuck PR Executions (Deduplicated)</h4>
                        <div class="table-container">
                            <table class="stuck-pr-table">
                                <thead>
                                    <tr>
                                        <th>Urgency</th>
                                        <th>Time Elapsed</th>
                                        <th>JIT Event ID</th>
                                        <th>Status</th>
                                        <th>Created At</th>
                                        <th>Repository</th>
                                        <th>Owner</th>
                                        <th>PR #</th>
                                        <th>PR Title</th>
                                        <th>Branch</th>
                                        <th>Commit SHA</th>
                                        <th>Event Type</th>
                                        <th>Link</th>
                                    </tr>
                                </thead>
                                <tbody id="stuck-pr-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Large Modal Window -->
    <div id="record-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Record Details</h3>
                <button class="modal-close" onclick="closeRecordModal()">Close</button>
            </div>
            <div class="modal-body">
                <div class="modal-actions">
                    <button class="modal-action-btn copy" id="modal-copy-btn">Copy Full JSON</button>
                    <button class="modal-action-btn" id="modal-copy-id-btn">Copy Execution ID</button>
                </div>
                <div class="modal-sections" id="modal-sections">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Data Modal -->
    <div id="additional-data-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="additional-modal-title">Additional Data</h3>
                <button class="modal-close" onclick="closeAdditionalDataModal()">Close</button>
            </div>
            <div class="modal-body">
                <div class="modal-actions">
                    <button class="modal-action-btn copy" id="additional-modal-copy-btn">Copy All Data</button>
                </div>
                <div class="additional-data-content" id="additional-data-content">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = [];
        let filterCounter = 0;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateAwsStatus();
            addCustomFilter();
            
            // Initialize AWS SDK with region
            AWS.config.update({
                region: 'us-east-1'
            });

            // Initialize the mode switch state to ensure form validation is properly set up
            const checkedRadio = document.querySelector('input[name="queryMode"]:checked');
            if (checkedRadio) {
                handleModeSwitch({ target: checkedRadio });
            }
        });

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to selected tab
            event.target.classList.add('active');
        }

        async function updateAwsStatus() {
            try {
                const response = await fetch('/api/aws-config');
                const config = await response.json();
                
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.querySelector('.status-text');
                
                // Verify AWS SDK is properly loaded
                const awsSdkVersion = AWS.VERSION || 'unknown';
                console.log('AWS SDK Version:', awsSdkVersion);

                if (config.error) {
                    statusIndicator.className = 'status-indicator error';
                    statusText.textContent = `AWS Error: ${config.error}`;
                } else if (config.hasCredentials) {
                    statusIndicator.className = 'status-indicator connected';
                    statusText.textContent = `Connected: ${config.region} (SDK v${awsSdkVersion})`;
                } else {
                    statusIndicator.className = 'status-indicator error';
                    statusText.textContent = 'No AWS credentials found';
                }
            } catch (error) {
                console.error('Error checking AWS connection:', error);
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.querySelector('.status-text');
                statusIndicator.className = 'status-indicator error';
                statusText.textContent = 'Connection error';
            }
        }

        function setupEventListeners() {
            document.getElementById('query-form').addEventListener('submit', handleQuery);
            document.getElementById('add-filter').addEventListener('click', () => addCustomFilter());
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            document.getElementById('stuck-pr-btn').addEventListener('click', findStuckPRExecutions);
            document.getElementById('clear-debug-btn').addEventListener('click', clearDebugResults);
            
            // Add query mode switching
            document.querySelectorAll('input[name="queryMode"]').forEach(radio => {
                radio.addEventListener('change', handleModeSwitch);
            });

            // Add click handlers for mode options
            document.querySelectorAll('.query-mode-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = true;
                        handleModeSwitch({ target: radio });
                    }
                });
            });
            
            // Add keyboard support for debug tenant ID input
            document.getElementById('debug-tenant-id').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('stuck-pr-btn').click();
                }
            });
        }


        async function downloadOutputFile(tenantId, jitEventId, executionId) {
            try {
                showNotification('Preparing download...', 'info');

                // Use server-side endpoint to generate signed URL
                const response = await fetch('/api/s3-signed-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tenantId,
                        jitEventId,
                        executionId
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to generate download URL');
                }

                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = result.signedUrl;
                link.download = result.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('Downloading output file...', 'success');
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('Error downloading output file: ' + error.message, 'error');
            }
        }

        // Function to download mountpoint directory
        async function downloadMountpoint(tenantId, jitEventId) {
            try {
                showNotification('Preparing mountpoint download...', 'info');

                // Verify we have the required parameters
                if (!tenantId || !jitEventId) {
                    throw new Error('Missing required parameters: tenantId and jitEventId');
                }

                    // Verify we have the required parameters
                    if (!tenantId || !jitEventId) {
                        throw new Error('Missing required parameters: tenantId and jitEventId');
                    }

                    // Check AWS token status first
                    const awsStatus = await fetch('/api/aws-config');
                    const awsConfig = await awsStatus.json();

                    if (awsConfig.error || !awsConfig.hasCredentials) {
                        throw new Error('AWS credentials are invalid or expired. Please refresh your session.');
                    }

                    // Use server-side endpoint to generate signed URL for mountpoint
                    const response = await fetch('/api/mountpoint-download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tenantId,
                            jitEventId
                        })
                    });

                    // Check for non-200 responses
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Server returned ${response.status}: ${response.statusText}`);
                    }

                const result = await response.json();

                if (!result.success) {
                    // Check for more detailed error information
                    if (result.triedBuckets) {
                        console.error('Tried buckets:', result.triedBuckets);
                        throw new Error(`${result.error} - Checked: ${result.triedBuckets.join(', ')}`);
                    } else {
                        throw new Error(result.error || 'Failed to generate mountpoint download URL');
                    }
                }

                console.log('Mountpoint download details:', {
                    fileName: result.fileName,
                    fileSize: result.fileSize,
                    bucket: result.bucket,
                    key: result.key,
                    totalFiles: result.totalFiles
                });

                // Create a temporary link element to trigger the download
                const link = document.createElement('a');
                link.href = result.signedUrl;
                link.download = result.fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification(`Downloading ${result.fileName} (${formatFileSize(result.fileSize)})...`, 'success');
            } catch (error) {
                console.error('Error downloading mountpoint:', error);

                // Check for token expiration
                if (error.message.includes('ExpiredToken') || error.message.includes('expired')) {
                    showNotification('Your AWS session has expired. Please refresh your session and try again.', 'error');
                } else {
                    showNotification('Error downloading mountpoint: ' + error.message, 'error');
                }
            }
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        function handleModeSwitch(event) {
            const selectedMode = event.target.value;
            const statusGroup = document.getElementById('status-group');
            const eventStatusGroup = document.getElementById('event-status-group');
            const queryBtnText = document.getElementById('query-btn-text');
            const statusField = document.getElementById('status');
            const eventStatusField = document.getElementById('event-status');
            
            // Update active mode styling
            document.querySelectorAll('.query-mode-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.query-mode-option').classList.add('active');

            if (selectedMode === 'executions') {
                // Show execution status field, hide event fields
                statusGroup.classList.remove('hidden');
                eventStatusGroup.classList.add('hidden');
                queryBtnText.textContent = 'Query Job Executions';
                statusField.required = true;
                eventStatusField.required = false;
                eventStatusField.value = ''; // Clear event status value
            } else if (selectedMode === 'events') {
                // Show event status field, hide execution status
                statusGroup.classList.add('hidden');
                eventStatusGroup.classList.remove('hidden');
                queryBtnText.textContent = 'Query JIT Events';
                statusField.required = false;
                statusField.value = ''; // Clear execution status value
                eventStatusField.required = true;
            }
        }

        function addCustomFilter(field = '', operator = 'contains', value = '') {
            const container = document.getElementById('custom-filters-container');
            const filterId = `filter-${filterCounter++}`;
            
            const filterDiv = document.createElement('div');
            filterDiv.className = 'custom-filter-row';
            filterDiv.dataset.filterId = filterId;
            
            filterDiv.innerHTML = `
                <div class="filter-inputs">
                    <input type="text" class="filter-field" placeholder="Field name (e.g., jit_event_name, context.jit_event.pull_request_number)" value="${field}">
                    <select class="filter-operator">
                        <option value="=" ${operator === '=' ? 'selected' : ''}>Equals</option>
                        <option value="contains" ${operator === 'contains' ? 'selected' : ''}>Contains</option>
                        <option value="begins_with" ${operator === 'begins_with' ? 'selected' : ''}>Begins With</option>
                        <option value=">" ${operator === '>' ? 'selected' : ''}>Greater Than</option>
                        <option value="<" ${operator === '<' ? 'selected' : ''}>Less Than</option>
                    </select>
                    <input type="text" class="filter-value" placeholder="Value" value="${value}">
                    <button type="button" class="remove-filter-btn" onclick="removeCustomFilter('${filterId}')">√ó</button>
                </div>
            `;
            
            container.appendChild(filterDiv);
        }

        function removeCustomFilter(filterId) {
            const filterRow = document.querySelector(`[data-filter-id="${filterId}"]`);
            if (filterRow) {
                filterRow.remove();
            }
        }

        function getCustomFilters() {
            const filters = [];
            const filterRows = document.querySelectorAll('.custom-filter-row');
            
            filterRows.forEach(row => {
                const field = row.querySelector('.filter-field').value.trim();
                const operator = row.querySelector('.filter-operator').value.trim();
                const value = row.querySelector('.filter-value').value.trim();
                
                if (field && value) {
                    filters.push({ field, operator, value });
                }
            });
            
            return filters;
        }

        async function handleQuery(e) {
            e.preventDefault();
            
            const tenantId = document.getElementById('tenant-id').value.trim();
            const queryMode = document.querySelector('input[name="queryMode"]:checked').value;
            const executionStatus = document.getElementById('status').value;
            const eventStatus = document.getElementById('event-status').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const customFilters = getCustomFilters();
            
            // Validation based on query mode
            if (!tenantId) {
                showError('Please enter a tenant ID');
                return;
            }
            
            if (queryMode === 'executions' && !executionStatus) {
                showError('Please select a status for Job Executions query');
                return;
            }
            
            if (queryMode === 'events' && !eventStatus) {
                showError('Please select a status for JIT Events query');
                return;
            }
            
            setLoadingState(true);
            hideError();
            
            try {
                let endpoint, params;
                
                if (queryMode === 'executions') {
                    endpoint = '/api/query';
                    params = {
                        tenantId,
                        status: executionStatus,
                        startDate: startDate ? new Date(startDate).toISOString() : null,
                        endDate: endDate ? new Date(endDate).toISOString() : null,
                        customFilters
                    };
                } else {
                    endpoint = '/api/query-jit-events';
                    params = {
                        tenantId,
                        status: eventStatus,
                        startDate: startDate ? new Date(startDate).toISOString() : null,
                        endDate: endDate ? new Date(endDate).toISOString() : null,
                        customFilters
                    };
                }
                
                console.log(`Querying ${queryMode} with endpoint ${endpoint}:`, params);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const result = await response.json();
                console.log('Query response:', result);
                
                if (result.success) {
                    console.log('Query successful, data:', result.data);
                    currentResults = result.data;
                    displayResults(result.data, queryMode);
                    updateResultsCount(result.count, result.scannedCount);
                } else {
                    console.error('Query failed:', result.error);
                    showError(`Query failed: ${result.error}`);
                    currentResults = [];
                    displayResults([], queryMode);
                    updateResultsCount(0, 0);
                }
            } catch (error) {
                console.error('Query error:', error);
                showError(`Unexpected error: ${error.message}`);
            } finally {
                setLoadingState(false);
            }
        }

        async function findStuckPRExecutions() {
            const tenantId = document.getElementById('debug-tenant-id').value.trim();
            
            if (!tenantId) {
                showError('Please enter a tenant ID for debugging');
                return;
            }
            
            const btn = document.getElementById('stuck-pr-btn');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            
            try {
                const response = await fetch('/api/stuck-pr-executions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tenantId })
                });
                
                const result = await response.json();
                console.log('Stuck PR response:', result);
                
                if (result.success) {
                    console.log('Statistics:', result.statistics);
                    console.log('Data:', result.data);
                    displayStuckPRStats(result.statistics);
                    displayStuckPRResults(result.data);
                } else {
                    console.error('Query failed:', result.error);
                    showError(`Failed to find stuck PRs: ${result.error}`);
                }
            } catch (error) {
                console.error('Stuck PR query error:', error);
                showError(`Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Find Stuck PR Executions';
            }
        }

        function displayStuckPRStats(stats) {
            console.log('displayStuckPRStats called with:', stats);
            const statsGrid = document.getElementById('stats-grid');
            const statsSection = document.getElementById('stuck-pr-stats');
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.total_stuck_prs}</div>
                    <div class="stat-label">Total Stuck PRs</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ef4444;">
                    <div class="stat-value" style="color: #ef4444;">${stats.critical_prs}</div>
                    <div class="stat-label">Critical (>10min)</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #f97316;">
                    <div class="stat-value" style="color: #f97316;">${stats.warning_prs}</div>
                    <div class="stat-label">Warning (3-10min)</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #10b981;">
                    <div class="stat-value" style="color: #10b981;">${stats.recent_prs}</div>
                    <div class="stat-label">Recent (<3min)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_pr_events_processed}</div>
                    <div class="stat-label">Total PR Events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_unique_prs_analyzed}</div>
                    <div class="stat-label">Unique PRs Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.total_scanned}</div>
                    <div class="stat-label">Total Items Scanned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.queries_executed}</div>
                    <div class="stat-label">Queries Executed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.repositories.length}</div>
                    <div class="stat-label">Repositories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.owners.length}</div>
                    <div class="stat-label">Owners</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.branches.length}</div>
                    <div class="stat-label">Branches</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.date_range_start ? formatDate(stats.date_range_start) : 'N/A'}</div>
                    <div class="stat-label">Search From Date</div>
                </div>
            `;
            
            statsSection.style.display = 'block';
            console.log('Stats section displayed');
        }

        function displayStuckPRResults(data) {
            console.log('displayStuckPRResults called with:', data);
            const tbody = document.getElementById('stuck-pr-tbody');
            const resultsSection = document.getElementById('stuck-pr-results');
            
            // Update the table headers to include new columns
            const tableHeader = resultsSection.querySelector('thead tr');
            tableHeader.innerHTML = `
                <th>Urgency</th>
                <th>Time Elapsed</th>
                <th>JIT Event ID</th>
                <th>Status</th>
                <th>Created At</th>
                <th>Repository</th>
                <th>Owner</th>
                <th>PR #</th>
                <th>PR Title</th>
                <th>Branch</th>
                <th>Commit SHA</th>
                <th>Event Type</th>
                <th>Link</th>
            `;
            
            tbody.innerHTML = '';
            
            data.forEach(pr => {
                const row = document.createElement('tr');
                
                // Determine urgency styling
                let urgencyBadge = '';
                let rowStyle = '';
                if (pr.urgency_level === 'red') {
                    urgencyBadge = '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">üî¥ CRITICAL</span>';
                    rowStyle = 'background-color: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444;';
                } else if (pr.urgency_level === 'orange') {
                    urgencyBadge = '<span style="background: #f97316; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">üü† WARNING</span>';
                    rowStyle = 'background-color: rgba(249, 115, 22, 0.1); border-left: 4px solid #f97316;';
                } else {
                    urgencyBadge = '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600;">üü¢ RECENT</span>';
                    rowStyle = 'background-color: rgba(16, 185, 129, 0.1); border-left: 4px solid #10b981;';
                }
                
                row.style.cssText = rowStyle;
                row.innerHTML = `
                    <td>${urgencyBadge}</td>
                    <td style="font-weight: 600;">${pr.time_ago} (${pr.elapsed_minutes}min)</td>
                    <td title="${pr.jit_event_id || 'N/A'}" style="font-family: monospace; font-size: 0.8rem; word-break: break-all;">${pr.jit_event_id || 'N/A'}</td>
                    <td><span style="background: #475569; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">${pr.status || 'N/A'}</span></td>
                    <td>${formatDate(pr.created_at)}</td>
                    <td>${pr.original_repository || 'N/A'}</td>
                    <td>${pr.owner || 'N/A'}</td>
                    <td style="font-weight: 600;">#${pr.pull_request_number || 'N/A'}</td>
                    <td title="${pr.pull_request_title || 'N/A'}" style="max-width: 300px; word-break: break-word;">${pr.pull_request_title || 'N/A'}</td>
                    <td><code style="background: #334155; color: #60a5fa; padding: 2px 4px; border-radius: 3px; font-size: 0.8rem; word-break: break-all;">${pr.branch || 'N/A'}</code></td>
                    <td title="${pr.commit_head_sha || 'N/A'}"><code style="background: #334155; color: #94a3b8; padding: 2px 4px; border-radius: 3px; font-size: 0.75rem; word-break: break-all;">${pr.commit_head_sha || 'N/A'}</code></td>
                    <td style="font-size: 0.85rem;">${pr.jit_event_name || 'N/A'}</td>
                    <td>${pr.url ? `<a href="${pr.url}" target="_blank" class="pr-link" style="font-weight: 600;">üìé View PR</a>` : 'N/A'}</td>
                `;
                tbody.appendChild(row);
            });
            
            resultsSection.style.display = 'block';
            console.log('Results section displayed with', data.length, 'rows');
        }

        function clearDebugResults() {
            document.getElementById('stuck-pr-stats').style.display = 'none';
            document.getElementById('stuck-pr-results').style.display = 'none';
            document.getElementById('debug-tenant-id').value = '';
        }

        function displayResults(results, queryMode = 'executions') {
            console.log('displayResults called with:', results, 'Mode:', queryMode);
            const table = document.getElementById('results-table');
            const tbody = document.getElementById('results-tbody');
            const thead = table.querySelector('thead tr');
            
            tbody.innerHTML = '';
            
            if (results.length === 0) {
                console.log('No results to display, hiding table');
                table.style.display = 'none';
                return;
            }
            
            // Update table headers based on query mode
            if (queryMode === 'executions') {
                thead.innerHTML = `
                    <th data-column="jit_event_id">JIT Event ID</th>
                    <th data-column="jit_event_name">Event Name</th>
                    <th data-column="execution_id">Execution ID</th>
                    <th data-column="status">Status</th>
                    <th data-column="control_name">Control Name</th>
                    <th data-column="asset_name">Asset Name</th>
                    <th data-column="pull_request_number">PR Number</th>
                    <th data-column="has_findings">Has Findings</th>
                    <th data-column="created_at">Created At</th>
                    <th data-column="completed_at">Completed At</th>
                    <th>Additional Data</th>
                    <th>Actions</th>
                `;
            } else {
                thead.innerHTML = `
                    <th data-column="jit_event_id">JIT Event ID</th>
                    <th data-column="jit_event_name">Event Name</th>
                    <th data-column="pull_request_number">PR Number</th>
                    <th data-column="created_at">Created At</th>
                    <th data-column="modified_at">Modified At</th>
                    <th data-column="progress">Progress</th>
                    <th data-column="status">Status</th>
                    <th>Additional Data</th>
                    <th>Actions</th>
                `;
            }
            
            const rows = results.map((item, index) => {
                const jitEventId = item.jit_event_id || 'N/A';
                const jitEventName = item.jit_event_name || 'N/A';
                const createdAt = formatDate(item.created_at);
                
                // Handle additional fields
                const additionalFields = getAdditionalFields(item, queryMode);
                
                if (queryMode === 'executions') {
                    return renderExecutionRow(item, index, jitEventId, jitEventName, createdAt, additionalFields);
                } else {
                    return renderEventRow(item, index, jitEventId, jitEventName, createdAt, additionalFields);
                }
            }).join('');
            
            tbody.innerHTML = rows;
            table.style.display = 'table';
            console.log('Results table displayed with', results.length, 'rows in', queryMode, 'mode');
        }

        function renderExecutionRow(item, index, jitEventId, jitEventName, createdAt, additionalFields) {
            const executionId = item.execution_id || 'N/A';
            const status = item.status || 'unknown';
            const controlName = item.control_name || 'N/A';
            const assetName = item.asset_name || 'N/A';
            const pullRequestNumber = item.context?.jit_event?.pull_request_number || 'N/A';
            const hasFindings = item.has_findings || 'N/A';
            const completedAt = formatDate(item.completed_at);
            
            return `
                <tr data-index="${index}">
                    <td class="expandable-cell" title="${jitEventId}">
                        <div class="cell-content">
                            <span class="cell-text">${jitEventId}</span>
                            ${jitEventId.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${jitEventId}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${jitEventName}">
                        <div class="cell-content">
                            <span class="cell-text">${truncateText(jitEventName, 25)}</span>
                            ${jitEventName.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${jitEventName}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${executionId}">
                        <div class="cell-content">
                            <span class="cell-text">${executionId}</span>
                            ${executionId.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${executionId}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td><span class="status-badge status-${status}">${status}</span></td>
                    <td class="expandable-cell" title="${controlName}">
                        <div class="cell-content">
                            <span class="cell-text">${truncateText(controlName, 25)}</span>
                            ${controlName.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${controlName}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${assetName}">
                        <div class="cell-content">
                            <span class="cell-text">${truncateText(assetName, 25)}</span>
                            ${assetName.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${assetName}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${pullRequestNumber}">
                        <div class="cell-content">
                            <span class="cell-text">${pullRequestNumber}</span>
                        </div>
                    </td>
                    <td class="expandable-cell" title="${hasFindings}">
                        <div class="cell-content">
                            <span class="cell-text">${truncateText(String(hasFindings), 25)}</span>
                            ${String(hasFindings).length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${String(hasFindings)}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${createdAt}">
                        <div class="cell-content">
                            <span class="cell-text">${createdAt}</span>
                        </div>
                    </td>
                    <td class="expandable-cell" title="${completedAt}">
                        <div class="cell-content">
                            <span class="cell-text">${completedAt}</span>
                        </div>
                    </td>
                    <td class="additional-fields-cell">
                        ${additionalFields.length > 0 ? `
                            <div class="additional-fields">
                                <span class="fields-count">${additionalFields.length} fields</span>
                                <button class="expand-btn small" onclick="openAdditionalDataModal(${index})">show</button>
                            </div>
                        ` : 'No additional data'}
                    </td>
                    <td class="actions-cell">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            <button class="action-btn kubectl" onclick="copyKubectlLogsCommand('${executionId}')">kubectl logs</button>
                            <button class="action-btn download" onclick="downloadOutputFile('${item.tenant_id}', '${jitEventId}', '${executionId}')">Download</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function renderEventRow(item, index, jitEventId, jitEventName, createdAt, additionalFields) {
            const modifiedAt = formatDate(item.modified_at);
            const pullRequestNumber = item.jit_event?.pull_request_number || 'N/A';
            
            // Calculate progress from remaining_assets and total_assets
            const remainingAssets = item.remaining_assets || 0;
            const totalAssets = item.total_assets || 0;
            let progressText = 'N/A';
            if (totalAssets > 0) {
                const completedAssets = totalAssets - remainingAssets;
                progressText = `${completedAssets}/${totalAssets}`;
            }
            
            // Extract status from GSI2PK_TENANT_ID_STATUS or use the status field directly
            let status = item.status || 'unknown';
            if (item.GSI2PK_TENANT_ID_STATUS && item.GSI2PK_TENANT_ID_STATUS.includes('#STATUS#')) {
                const statusPart = item.GSI2PK_TENANT_ID_STATUS.split('#STATUS#')[1];
                if (statusPart) {
                    status = statusPart;
                }
            }
            
            return `
                <tr data-index="${index}">
                    <td class="expandable-cell" title="${jitEventId}">
                        <div class="cell-content">
                            <span class="cell-text">${jitEventId}</span>
                            ${jitEventId.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${jitEventId}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${jitEventName}">
                        <div class="cell-content">
                            <span class="cell-text">${truncateText(jitEventName, 25)}</span>
                            ${jitEventName.length > 25 ? `<button class="expand-cell-btn" onclick="toggleCellExpansion(this, '${jitEventName}')">‚ãØ</button>` : ''}
                        </div>
                    </td>
                    <td class="expandable-cell" title="${pullRequestNumber}">
                        <div class="cell-content">
                            <span class="cell-text">${pullRequestNumber}</span>
                        </div>
                    </td>
                    <td class="expandable-cell" title="${createdAt}">
                        <div class="cell-content">
                            <span class="cell-text">${createdAt}</span>
                        </div>
                    </td>
                    <td class="expandable-cell" title="${modifiedAt}">
                        <div class="cell-content">
                            <span class="cell-text">${modifiedAt}</span>
                        </div>
                    </td>
                    <td class="expandable-cell" title="Completed: ${totalAssets - remainingAssets}, Remaining: ${remainingAssets}, Total: ${totalAssets}">
                        <div class="cell-content">
                            <span class="cell-text" style="font-weight: 600; color: ${remainingAssets === 0 && totalAssets > 0 ? '#10b981' : '#60a5fa'};">${progressText}</span>
                        </div>
                    </td>
                    <td><span class="status-badge status-${status}">${status}</span></td>
                    <td class="additional-fields-cell">
                        ${additionalFields.length > 0 ? `
                            <div class="additional-fields">
                                <span class="fields-count">${additionalFields.length} fields</span>
                                <button class="expand-btn small" onclick="openAdditionalDataModal(${index})">show</button>
                            </div>
                        ` : 'No additional data'}
                    </td>
                    <td class="actions-cell">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.3rem;">
                            <button class="action-btn view" onclick="viewDetails('${jitEventId}')">View</button>
                            <button class="action-btn copy" onclick="copyToClipboard('${jitEventId}')">Copy</button>
                            <button class="action-btn expand-row" onclick="openRecordModal(${index})">Expand</button>
                            <button class="action-btn download" onclick="downloadMountpoint('${item.tenant_id}', '${jitEventId}')">Download</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function clearFilters() {
            document.getElementById('custom-filters-container').innerHTML = '';
            addCustomFilter();
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString();
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function updateResultsCount(count, scannedCount) {
            const resultsCount = document.getElementById('results-count');
            if (count > 0) {
                resultsCount.textContent = `Found ${count} results (scanned ${scannedCount} items)`;
            } else {
                resultsCount.textContent = '';
            }
        }

        function setLoadingState(loading) {
            const btn = document.querySelector('.btn-primary');
            const btnText = btn.querySelector('.btn-text');
            
            if (loading) {
                btn.disabled = true;
                btnText.textContent = 'Querying...';
            } else {
                btn.disabled = false;
                btnText.textContent = 'Query DynamoDB';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        function viewDetails(executionId) {
            const item = currentResults.find(r => r.execution_id === executionId);
            if (item) {
                alert(JSON.stringify(item, null, 2));
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Data copied to clipboard!');
            });
        }

        // Copy kubectl logs command for execution
        function copyKubectlLogsCommand(executionId) {
            const tenantId = document.getElementById('tenant-id').value.trim();
            
            if (!tenantId) {
                alert('Tenant ID is required to generate kubectl command');
                return;
            }
            
            if (!executionId || executionId === 'N/A') {
                alert('Valid execution ID is required to generate kubectl command');
                return;
            }
            
            // Extract first part of execution_id (before first hyphen)
            const executionIdPart = executionId.split('-')[0];
            
            // Generate kubectl command
            const kubectlCommand = `POD_NAME=$(kubectl-prod -n ${tenantId} get pods --no-headers | grep "${executionIdPart}" | awk '{print $1}')
kubectl-prod -n ${tenantId} logs $POD_NAME`;
            
            navigator.clipboard.writeText(kubectlCommand).then(() => {
                alert('kubectl logs command copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy kubectl command:', err);
                alert('Failed to copy kubectl command to clipboard');
            });
        }

        // Get additional fields beyond the main ones
        function getAdditionalFields(item, queryMode = 'executions') {
            let mainFields;
            
            if (queryMode === 'executions') {
                mainFields = ['jit_event_id', 'event_id', 'jit_event_name', 'execution_id', 'status', 'control_name', 'asset_name', 'pull_request_number', 'has_findings', 'created_at', 'completed_at', 'errors'];
            } else {
                mainFields = ['jit_event_id', 'jit_event_name', 'pull_request_number', 'created_at', 'modified_at', 'remaining_assets', 'total_assets', 'status', 'GSI2PK_TENANT_ID_STATUS', 'tenant_id'];
            }
            
            const additionalFields = [];
            
            Object.keys(item).forEach(key => {
                if (!mainFields.includes(key)) {
                    const value = item[key];
                    if (value !== null && value !== undefined) {
                        const displayValue = typeof value === 'object' ? 
                            JSON.stringify(value, null, 2) : 
                            String(value);
                        additionalFields.push(`${key}: ${truncateText(displayValue, 100)}`);
                    }
                }
            });
            
            return additionalFields;
        }

        // Toggle error expansion
        function toggleErrorExpansion(index) {
            const errorFull = document.getElementById(`error-${index}`);
            const expandBtn = document.querySelector(`[onclick="toggleErrorExpansion(${index})"]`);
            
            if (errorFull.style.display === 'none') {
                errorFull.style.display = 'block';
                expandBtn.textContent = 'collapse';
            } else {
                errorFull.style.display = 'none';
                expandBtn.textContent = 'expand';
            }
        }

        // Toggle cell expansion for long text
        function toggleCellExpansion(button, fullText) {
            const cellContent = button.parentElement;
            const cellText = button.previousElementSibling;
            const isExpanded = button.textContent === '‚ãØ';
            
            if (isExpanded) {
                cellText.textContent = fullText;
                button.textContent = '‚åÉ';
                button.title = 'Collapse';
                cellContent.classList.add('expanded');
            } else {
                cellText.textContent = truncateText(fullText, 25);
                button.textContent = '‚ãØ';
                button.title = 'Expand';
                cellContent.classList.remove('expanded');
            }
        }

        // Toggle additional fields display
        function toggleAdditionalFields(index) {
            const content = document.getElementById(`additional-${index}`);
            const button = document.querySelector(`[onclick="toggleAdditionalFields(${index})"]`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = 'hide';
                button.classList.add('expanded');
            } else {
                content.style.display = 'none';
                button.textContent = 'show';
                button.classList.remove('expanded');
            }
        }

        // Open record modal
        function openRecordModal(index) {
            const item = currentResults[index];
            const modal = document.getElementById('record-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSections = document.getElementById('modal-sections');
            const modalCopyBtn = document.getElementById('modal-copy-btn');
            const modalCopyIdBtn = document.getElementById('modal-copy-id-btn');

            modalTitle.textContent = `Record Details - ${item.execution_id || 'N/A'}`;
            modalSections.innerHTML = '';

            // Basic Information Section
            modalSections.innerHTML += `
                <div class="modal-section">
                    <h4>üìã Basic Information</h4>
                    <div class="modal-info-grid">
                        <div class="modal-info-item">
                            <span class="modal-info-label">JIT Event ID:</span>
                            <span class="modal-info-value">${item.jit_event_id || 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Execution ID:</span>
                            <span class="modal-info-value">${item.execution_id || 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Event Name:</span>
                            <span class="modal-info-value">${item.jit_event_name || 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Status:</span>
                            <span class="modal-info-value status-${item.status || 'unknown'}">${item.status || 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Control Name:</span>
                            <span class="modal-info-value">${item.control_name || 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Created At:</span>
                            <span class="modal-info-value">${item.created_at ? formatDate(item.created_at) : 'N/A'}</span>
                        </div>
                        <div class="modal-info-item">
                            <span class="modal-info-label">Completed At:</span>
                            <span class="modal-info-value">${item.completed_at ? formatDate(item.completed_at) : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;

            // Errors Section
            if (item.errors && item.errors.length > 0) {
                modalSections.innerHTML += `
                    <div class="modal-section">
                        <h4>üö® Errors (${item.errors.length})</h4>
                        <div class="modal-errors">
                            ${item.errors.map((error, errorIndex) => `
                                <div class="modal-error-item">
                                    <div class="modal-error-header">Error ${errorIndex + 1}:</div>
                                    <div class="modal-error-content">
                                        <pre>${JSON.stringify(error, null, 2)}</pre>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Context Information Section
            if (item.context) {
                modalSections.innerHTML += `
                    <div class="modal-section">
                        <h4>üìù Context Information</h4>
                        <div class="modal-context-sections">
                `;

                // JIT Event Context
                if (item.context.jit_event) {
                    modalSections.innerHTML += `
                        <div class="modal-context-subsection">
                            <h5>üîó JIT Event Details</h5>
                            <div class="modal-info-grid">
                                <div class="modal-info-item">
                                    <span class="modal-info-label">PR Number:</span>
                                    <span class="modal-info-value">${item.context.jit_event.pull_request_number || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">PR Title:</span>
                                    <span class="modal-info-value">${item.context.jit_event.pull_request_title || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Branch:</span>
                                    <span class="modal-info-value">${item.context.jit_event.branch || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Owner:</span>
                                    <span class="modal-info-value">${item.context.jit_event.owner || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">User:</span>
                                    <span class="modal-info-value">${item.context.jit_event.user_vendor_name || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">URL:</span>
                                    <span class="modal-info-value">${item.context.jit_event.url ? `<a href="${item.context.jit_event.url}" target="_blank" class="pr-link">${item.context.jit_event.url}</a>` : 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Asset Context
                if (item.context.asset) {
                    modalSections.innerHTML += `
                        <div class="modal-context-subsection">
                            <h5>üéØ Asset Information</h5>
                            <div class="modal-info-grid">
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Asset ID:</span>
                                    <span class="modal-info-value">${item.context.asset.asset_id || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Asset Name:</span>
                                    <span class="modal-info-value">${item.context.asset.asset_name || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Asset Type:</span>
                                    <span class="modal-info-value">${item.context.asset.asset_type || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Environment:</span>
                                    <span class="modal-info-value">${item.context.asset.environment || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Priority Score:</span>
                                    <span class="modal-info-value">${item.context.asset.priority_score || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Is Covered:</span>
                                    <span class="modal-info-value">${item.context.asset.is_covered ? 'Yes' : 'No'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Job Context
                if (item.context.job) {
                    modalSections.innerHTML += `
                        <div class="modal-context-subsection">
                            <h5>‚öôÔ∏è Job Configuration</h5>
                            <div class="modal-info-grid">
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Job Name:</span>
                                    <span class="modal-info-value">${item.context.job.job_name || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Runner Type:</span>
                                    <span class="modal-info-value">${item.context.job.runner?.type || 'N/A'}</span>
                                </div>
                                <div class="modal-info-item">
                                    <span class="modal-info-label">Steps Count:</span>
                                    <span class="modal-info-value">${item.context.job.steps?.length || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                modalSections.innerHTML += `
                        </div>
                    </div>
                `;
            }

            // Raw JSON Section
            modalSections.innerHTML += `
                <div class="modal-section">
                    <h4>üìä Complete Raw Data</h4>
                    <div class="modal-raw-json">
                        <pre>${JSON.stringify(item, null, 2)}</pre>
                    </div>
                </div>
            `;

            // Set up copy buttons
            modalCopyBtn.onclick = () => {
                navigator.clipboard.writeText(JSON.stringify(item, null, 2)).then(() => {
                    alert('Full JSON copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy data.');
                });
            };

            modalCopyIdBtn.onclick = () => {
                navigator.clipboard.writeText(item.execution_id || 'N/A').then(() => {
                    alert('Execution ID copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy execution ID.');
                });
            };

            modal.style.display = 'flex';
        }

        // Close record modal
        function closeRecordModal() {
            document.getElementById('record-modal').style.display = 'none';
        }

        // Open additional data modal
        function openAdditionalDataModal(index) {
            const item = currentResults[index];
            const modal = document.getElementById('additional-data-modal');
            const modalTitle = document.getElementById('additional-modal-title');
            const modalContent = document.getElementById('additional-data-content');
            const modalCopyBtn = document.getElementById('additional-modal-copy-btn');

            modalTitle.textContent = `Additional Data - ${item.execution_id || 'N/A'}`;
            
            // Get all additional fields without truncation
            const mainFields = ['jit_event_id', 'event_id', 'jit_event_name', 'execution_id', 'status', 'control_name', 'asset_name', 'has_findings', 'created_at', 'completed_at', 'errors'];
            const additionalFields = [];
            
            Object.keys(item).forEach(key => {
                if (!mainFields.includes(key)) {
                    const value = item[key];
                    if (value !== null && value !== undefined) {
                        additionalFields.push({ key, value });
                    }
                }
            });

            if (additionalFields.length === 0) {
                modalContent.innerHTML = '<div class="no-additional-data">No additional data available for this record.</div>';
            } else {
                // Group fields by type for better organization
                const stringFields = [];
                const objectFields = [];
                const arrayFields = [];
                const otherFields = [];

                additionalFields.forEach(({ key, value }) => {
                    if (Array.isArray(value)) {
                        arrayFields.push({ key, value });
                    } else if (typeof value === 'object') {
                        objectFields.push({ key, value });
                    } else if (typeof value === 'string') {
                        stringFields.push({ key, value });
                    } else {
                        otherFields.push({ key, value });
                    }
                });

                let content = '';

                // String fields
                if (stringFields.length > 0) {
                    content += `
                        <div class="additional-data-section">
                            <h4>üìù Text Fields (${stringFields.length})</h4>
                            <div class="additional-data-grid">
                                ${stringFields.map(({ key, value }) => `
                                    <div class="additional-data-item">
                                        <div class="additional-data-label">${key}:</div>
                                        <div class="additional-data-value string-value">${value}</div>
                                        <button class="copy-field-btn" onclick="copyFieldValue('${key}', '${value.replace(/'/g, "\\'")}')">Copy</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Other primitive fields
                if (otherFields.length > 0) {
                    content += `
                        <div class="additional-data-section">
                            <h4>üî¢ Other Fields (${otherFields.length})</h4>
                            <div class="additional-data-grid">
                                ${otherFields.map(({ key, value }) => `
                                    <div class="additional-data-item">
                                        <div class="additional-data-label">${key}:</div>
                                        <div class="additional-data-value other-value">${String(value)}</div>
                                        <button class="copy-field-btn" onclick="copyFieldValue('${key}', '${String(value).replace(/'/g, "\\'")}')">Copy</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Array fields
                if (arrayFields.length > 0) {
                    content += `
                        <div class="additional-data-section">
                            <h4>üìö Array Fields (${arrayFields.length})</h4>
                            ${arrayFields.map(({ key, value }) => `
                                <div class="additional-data-complex">
                                    <div class="additional-data-complex-header">
                                        <span class="additional-data-label">${key} (${value.length} items):</span>
                                        <button class="copy-field-btn" onclick="copyFieldValue('${key}', '${JSON.stringify(value).replace(/'/g, "\\'")}')">Copy</button>
                                    </div>
                                    <div class="additional-data-json">
                                        <pre>${JSON.stringify(value, null, 2)}</pre>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Object fields
                if (objectFields.length > 0) {
                    content += `
                        <div class="additional-data-section">
                            <h4>üóÇÔ∏è Object Fields (${objectFields.length})</h4>
                            ${objectFields.map(({ key, value }) => `
                                <div class="additional-data-complex">
                                    <div class="additional-data-complex-header">
                                        <span class="additional-data-label">${key}:</span>
                                        <button class="copy-field-btn" onclick="copyFieldValue('${key}', '${JSON.stringify(value).replace(/'/g, "\\'")}')">Copy</button>
                                    </div>
                                    <div class="additional-data-json">
                                        <pre>${JSON.stringify(value, null, 2)}</pre>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                modalContent.innerHTML = content;
            }

            // Set up copy all button
            modalCopyBtn.onclick = () => {
                const allAdditionalData = {};
                additionalFields.forEach(({ key, value }) => {
                    allAdditionalData[key] = value;
                });
                
                navigator.clipboard.writeText(JSON.stringify(allAdditionalData, null, 2)).then(() => {
                    alert('All additional data copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy data.');
                });
            };

            modal.style.display = 'flex';
        }

        // Close additional data modal
        function closeAdditionalDataModal() {
            document.getElementById('additional-data-modal').style.display = 'none';
        }

        // Copy individual field value
        function copyFieldValue(fieldName, value) {
            navigator.clipboard.writeText(value).then(() => {
                alert(`${fieldName} copied to clipboard!`);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy field value.');
            });
        }

        // Helper function to format file sizes in human-readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeRecordModal();
                closeAdditionalDataModal();
            }
        });

        // Close modal when clicking outside
        document.getElementById('record-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeRecordModal();
            }
        });

        // Close additional data modal when clicking outside
        document.getElementById('additional-data-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAdditionalDataModal();
            }
        });
    </script>
</body>
</html> 